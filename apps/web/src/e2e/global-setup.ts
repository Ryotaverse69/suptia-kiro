/**
 * Playwright ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
 * E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã®åˆæœŸåŒ–å‡¦ç†
 */

import { chromium, FullConfig } from '@playwright/test';

async function globalSetup(config: FullConfig) {
  console.log('ğŸš€ E2Eãƒ†ã‚¹ãƒˆã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹...');

  // ãƒ–ãƒ©ã‚¦ã‚¶ã‚’èµ·å‹•ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æº–å‚™çŠ¶æ…‹ã‚’ç¢ºèª
  const browser = await chromium.launch();
  const page = await browser.newPage();

  try {
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
    const baseURL = config.projects[0].use.baseURL || 'http://localhost:3000';
    console.log(`ğŸ“¡ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã‚’ç¢ºèªä¸­: ${baseURL}`);
    
    await page.goto(baseURL, { waitUntil: 'networkidle' });
    
    // åŸºæœ¬çš„ãªãƒšãƒ¼ã‚¸è¦ç´ ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    await page.waitForSelector('header', { timeout: 10000 });
    await page.waitForSelector('main', { timeout: 10000 });
    
    console.log('âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã‚’ç¢ºèªã—ã¾ã—ãŸ');

    // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    // await resetTestDatabase();

    // ãƒ†ã‚¹ãƒˆç”¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
    await page.evaluate(() => {
      localStorage.clear();
      sessionStorage.clear();
    });

    console.log('ğŸ§¹ ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ');

  } catch (error) {
    console.error('âŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
    throw error;
  } finally {
    await browser.close();
  }

  console.log('âœ… E2Eãƒ†ã‚¹ãƒˆã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ');
}

export default globalSetup;