# MCP自動承認最適化 - 使用ガイド

## 概要

個人開発効率を最大化するため、MCP（Model Context Protocol）の自動承認ポリシーを最適化しました。
本番影響のない操作を自動承認し、Trust要求の煩わしさを削減します。

## 変更内容

### 🟢 自動承認（Trust不要）

#### filesystem操作
```bash
# これらの操作はTrust要求なしで実行されます
- ファイル読み取り・書き込み
- ディレクトリ作成・削除  
- レポート生成・ログ分析
- テストファイル作成・実行
- 設定ファイル更新
```

#### 情報収集系
```bash
# これらの操作はTrust要求なしで実行されます
- brave_web_search（Web検索）
- brave_local_search（ローカル検索）
- fetch（許可ドメインへのGET/HEAD/OPTIONS）
```

#### 許可ドメイン
- `*.sanity.io` - Sanity CMS API
- `*.suptia.com` - 自社ドメイン
- `*.vercel.com` - Vercel関連
- `api.vercel.com` - Vercel REST API
- `github.com` - GitHub Web
- `api.github.com` - GitHub API（読み取り系）
- `registry.npmjs.org` - npm registry
- `localhost`, `127.0.0.1` - 開発環境

### 🔴 手動承認（Trust必須）

#### 本番影響操作
```bash
# これらの操作は引き続きTrust要求が表示されます
- GitHub: コミット・プッシュ・PR作成・設定変更
- Sanity: コンテンツ作成・更新・削除・リリース管理
- インフラ: デプロイ・ドメイン追加・環境変数設定
```

## 使用方法

### 日常的な開発作業
1. **ローカルファイル操作** - Trust要求なしで即座に実行
2. **情報収集・調査** - Trust要求なしで効率的にリサーチ
3. **レポート生成** - Trust要求なしで自動化

### 本番環境への変更
1. **GitHub操作** - Trust要求を確認して慎重に実行
2. **Sanity操作** - Trust要求を確認して慎重に実行
3. **インフラ操作** - Trust要求を確認して慎重に実行

## セキュリティ保証

### 自動承認の安全性
- **ローカル限定**: filesystem操作は本番環境に影響なし
- **ドメイン制限**: fetch操作は許可ドメインのみアクセス可能
- **メソッド制限**: 書き込み系メソッド（POST/PUT/PATCH/DELETE）は自動承認対象外
- **読み取り専用**: 情報収集系は読み取り専用で安全

### 手動承認の維持
- **本番直結**: リポジトリ・CMS・インフラ変更は手動承認必須
- **変更履歴**: 承認プロセスにより変更の意図と影響を明確化
- **リスク管理**: 重要な操作は引き続き慎重に管理

## 監査・ログ

### 自動記録
- 自動承認操作も `.kiro/reports/` に記録
- 直近100件の操作履歴を保持
- 問題発生時の追跡可能性を確保

### 定期レビュー
- 月次でポリシーの見直し
- 自動承認範囲の適切性確認
- セキュリティインシデントの有無確認

## トラブルシューティング

### 自動承認が機能しない場合
1. `.kiro/settings/mcp.json`の設定確認
2. MCPサーバーの再起動
3. Kiro IDEの再起動

### 予期しないTrust要求が表示される場合
1. 操作内容の確認（本番影響があるか）
2. ドメインが許可リストに含まれているか確認
3. メソッドが読み取り系か確認

### 緊急時のロールバック
```bash
# 設定を元に戻す
cp ~/.kiro/settings/mcp.json.backup ~/.kiro/settings/mcp.json

# または手動で autoApprove を空配列に設定
# "autoApprove": []
```

## 期待される効果

### 開発効率向上
- ローカル作業の煩わしいTrust要求を削減
- 情報収集・調査作業の自動化
- レポート生成・ログ分析の効率化

### リスク管理
- 本番環境への影響操作は引き続き手動承認
- セキュリティポリシーの遵守
- 変更履歴の追跡可能性を維持

## サポート

### 問題報告
- 設定に問題がある場合は即座にロールバック
- `.kiro/reports/mcp-autotrust-log-*.md` でログ確認
- 必要に応じてポリシーの調整

### 改善提案
- 自動承認範囲の拡張・縮小提案
- 新しいMCPサーバーの追加提案
- セキュリティポリシーの改善提案

---

**重要**: この最適化は個人開発に特化しています。
チーム開発に移行する場合は、承認プロセスの見直しが必要です。