# Requirements Document

**specVersion**: 2025-08-16

## Introduction

Suptia M3（プラットフォーム化）では、M2で構築した収益化基盤を拡張し、プラットフォーム化機能を実現します。摂取ログ/目標管理、継続学習リコメンド、外部連携、コミュニティ機能を通じて、ユーザーが継続的にサプリメント摂取を管理し、パーソナライズされた推奨を受け、他のユーザーと情報共有できるプラットフォームを構築します。

M3スコープ：摂取ログスキーマ → 重み再学習（説明可能AI） → OAuth/同意管理 → コミュニティMVP → モデレーション → ログ復元機能 → 重み変更説明 → 外部データオプトイン必須。

## Requirements

### Requirement 1

**User Story:** ユーザーとして、サプリメントの摂取ログと目標を管理したい。そうすることで、継続的な摂取状況を把握し、目標達成に向けた進捗を確認できる。

#### Acceptance Criteria

1. WHEN 摂取ログを記録する THEN システムは商品ID・摂取量・摂取時刻・メモを保存する SHALL
2. WHEN 摂取目標を設定する THEN システムは期間・目標摂取量・アラート設定を管理する SHALL
3. WHEN 摂取履歴を表示する THEN システムは日次・週次・月次の摂取状況をグラフで表示する SHALL
4. WHEN 目標達成状況を確認する THEN システムは進捗率・達成予測・改善提案を表示する SHALL
5. WHEN ログデータを復元する THEN システムは削除されたログを30日以内であれば復元できる SHALL

### Requirement 2

**User Story:** ユーザーとして、継続学習によるパーソナライズされたリコメンドを受けたい。そうすることで、自分の摂取履歴と目標に基づいた最適な商品推奨を受けることができる。

#### Acceptance Criteria

1. WHEN リコメンドを生成する THEN システムは摂取履歴・目標・評価・購入履歴を学習データとして使用する SHALL
2. WHEN 重みを更新する THEN システムはユーザーフィードバックに基づいて推奨アルゴリズムの重みを再学習する SHALL
3. WHEN 重み変更を説明する THEN システムは「なぜこの商品が推奨されるか」の理由を具体的に表示する SHALL
4. WHEN 学習結果を検証する THEN システムは推奨精度の向上を定量的に測定・表示する SHALL
5. WHEN 説明可能性を提供する THEN システムは重み変更の根拠と影響を分かりやすく説明する SHALL

### Requirement 3

**User Story:** ユーザーとして、外部サービスと連携してデータを活用したい。そうすることで、健康管理アプリや購入履歴と連携した総合的な健康管理ができる。

#### Acceptance Criteria

1. WHEN 外部連携を設定する THEN システムはOAuth 2.0による安全な認証・認可を実装する SHALL
2. WHEN データ連携を行う THEN システムはユーザーの明示的な同意を必須とする SHALL
3. WHEN 外部データを取得する THEN システムは健康管理アプリ・購入履歴・活動データの連携を提供する SHALL
4. WHEN 連携データを使用する THEN システムはオプトイン必須でデータ使用目的を明確に説明する SHALL
5. WHEN 連携を解除する THEN システムはワンクリックでの連携解除と関連データ削除を提供する SHALL

### Requirement 4

**User Story:** ユーザーとして、コミュニティで他のユーザーと情報共有したい。そうすることで、サプリメント体験や効果について安全な範囲で情報交換できる。

#### Acceptance Criteria

1. WHEN コミュニティ投稿を作成する THEN システムは商品レビュー・摂取体験・質問・回答の投稿を提供する SHALL
2. WHEN 投稿内容を検証する THEN システムは薬機法準拠の自動モデレーションを実装する SHALL
3. WHEN ユーザー評価を行う THEN システムは投稿の有用性評価・いいね・フォロー機能を提供する SHALL
4. WHEN コミュニティを管理する THEN システムは不適切投稿の報告・削除・ユーザー制限機能を提供する SHALL
5. WHEN 投稿を表示する THEN システムは「個人の体験です」等の免責事項を必ず表示する SHALL

### Requirement 5

**User Story:** 管理者として、コミュニティの健全性を維持したい。そうすることで、薬機法準拠と安全な情報共有環境を保証できる。

#### Acceptance Criteria

1. WHEN 自動モデレーションを実行する THEN システムは医療効果・疾患名・治療効果の断定表現を自動検出・削除する SHALL
2. WHEN 人的モデレーションを行う THEN システムは疑わしい投稿を管理者キューに送信し、手動確認を要求する SHALL
3. WHEN 違反投稿を処理する THEN システムは警告・一時制限・永久制限の段階的制裁を適用する SHALL
4. WHEN モデレーション履歴を管理する THEN システムは全ての制裁履歴・理由・期間を記録・追跡する SHALL
5. WHEN 異議申し立てを処理する THEN システムは制裁に対する異議申し立てと再審査機能を提供する SHALL

### Requirement 6

**User Story:** 開発者として、M3機能のパフォーマンスを監視したい。そうすることで、ログ処理・学習処理・コミュニティ機能の性能を最適化できる。

#### Acceptance Criteria

1. WHEN ログ処理を監視する THEN システムは摂取ログの書き込み・読み込み・集計処理の性能を測定する SHALL
2. WHEN 学習処理を監視する THEN システムは重み再学習の実行時間・メモリ使用量・精度向上を測定する SHALL
3. WHEN コミュニティ処理を監視する THEN システムは投稿・モデレーション・検索の応答時間を測定する SHALL
4. WHEN 外部連携を監視する THEN システムはOAuth認証・データ取得・同期処理の成功率を測定する SHALL
5. WHEN アラートを設定する THEN システムは性能劣化・エラー率上昇・処理遅延の自動アラートを提供する SHALL

### Requirement 7

**User Story:** 視覚障害者として、M3新機能が適切にアクセシブルであることを期待する。そうすることで、ログ管理・コミュニティ・外部連携をスクリーンリーダーで利用できる。

#### Acceptance Criteria

1. WHEN 摂取ログを入力する THEN システムはログ入力フォームに適切なlabel・aria-describedby属性を設定する SHALL
2. WHEN 摂取履歴グラフを表示する THEN システムはグラフデータをテーブル形式でも提供し、キーボード操作を可能にする SHALL
3. WHEN コミュニティ投稿を作成する THEN システムは投稿フォームでaria-invalid・aria-describedby属性を適切に設定する SHALL
4. WHEN 外部連携を設定する THEN システムはOAuth認証画面でスクリーンリーダー対応の説明を提供する SHALL
5. WHEN リコメンド説明を表示する THEN システムは推奨理由をaria-label・aria-describedby属性で詳細説明する SHALL

### Requirement 8

**User Story:** 開発者として、M3機能のドキュメントを最新状態に保ちたい。そうすることで、ログ管理・学習・外部連携・コミュニティ機能の仕様を正確に伝えることができる。

#### Acceptance Criteria

1. WHEN ドキュメント更新を実行する THEN システムはREADME.mdにM3新機能（ログ管理・学習・外部連携・コミュニティ）を追記する SHALL
2. WHEN 学習仕様書を作成する THEN システムはdocs/LEARNING.mdに重み再学習・説明可能AI仕様を記載する SHALL
3. WHEN 連携仕様書を作成する THEN システムはdocs/INTEGRATIONS.mdにOAuth・外部データ連携仕様を記載する SHALL
4. WHEN コミュニティ仕様書を作成する THEN システムはdocs/COMMUNITY.mdに投稿・モデレーション・制裁仕様を記載する SHALL
5. WHEN ドキュメント生成を実行する THEN システムは差分のみでPRを作成し、automergeラベルを付与する SHALL

### Requirement 9

**User Story:** 開発者として、M3品質基準を満たしたい。そうすることで、ログ復元、重み変更説明、外部データオプトイン必須を保証できる。

#### Acceptance Criteria

1. WHEN ログ復元を実行する THEN システムは削除されたログを30日以内であれば完全に復元できる SHALL
2. WHEN 重み変更を説明する THEN システムは推奨アルゴリズムの重み変更理由を具体的に説明できる SHALL
3. WHEN 外部データを使用する THEN システムはユーザーの明示的なオプトイン同意を必須とする SHALL
4. WHEN モデレーションを実行する THEN システムは薬機法違反表現を自動検出し、適切に処理する SHALL
5. WHEN CI品質チェックを実行する THEN システムは上記4項目の自動検証をCIパイプラインで実行する SHALL

### Requirement 10

**User Story:** ユーザーとして、プライバシーとデータ管理を適切に行いたい。そうすることで、個人データの使用状況を把握し、必要に応じて削除・修正できる。

#### Acceptance Criteria

1. WHEN データ使用状況を確認する THEN システムは収集データ・使用目的・共有先・保存期間を明示する SHALL
2. WHEN データ削除を要求する THEN システムは30日以内にユーザーデータの完全削除を実行する SHALL
3. WHEN データ修正を要求する THEN システムは不正確なデータの修正・更新機能を提供する SHALL
4. WHEN データポータビリティを要求する THEN システムはJSON形式でのデータエクスポート機能を提供する SHALL
5. WHEN 同意管理を行う THEN システムは各機能・データ使用に対する個別同意の管理機能を提供する SHALL