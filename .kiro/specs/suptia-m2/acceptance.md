# Acceptance Criteria

**specVersion**: 2025-08-16

## M2: 信頼性 & 収益化強化 - 受け入れ基準

### 1. 禁止表現0件

**検証項目:**
- [ ] 口コミ要約で薬機法違反表現が0件である
- [ ] 医療効果・疾患名・治療効果の断定表現が除去される
- [ ] 必須免責事項（「個人の感想です」「効果には個人差があります」）が含まれる
- [ ] 禁止表現検出時に要約生成が停止される

**テストケース:**
```
Given: 医療効果を断定する口コミが入力される
When: 安全要約パイプラインを実行する
Then: 該当表現が自動除去される
And: 免責事項が追加される
And: 薬機法違反表現が0件になる
```

### 2. グラフ整合性

**検証項目:**
- [ ] 価格履歴グラフで異常値（前日比50%以上変動）が検出される
- [ ] 各ソース別の価格推移が異なる色・線種で表示される
- [ ] マウスオーバーでツールチップが正しく表示される
- [ ] データ不足時に警告と利用可能期間が表示される

**テストケース:**
```
Given: 価格履歴データに前日比60%の価格変動がある
When: 価格履歴グラフを表示する
Then: 異常値として検出される
And: 確認マークが表示される
And: データの整合性が保たれる
```

### 3. クリック計測重複なし

**検証項目:**
- [ ] 同一セッション・同一商品・同一ソースで5分以内の重複クリックが除外される
- [ ] クリック情報（商品ID・ソース・ユーザーセッション・タイムスタンプ）が正確に記録される
- [ ] コンバージョン追跡が各アフィリエイトプログラムで動作する
- [ ] 重複クリック除外の検証で0件が確認される

**テストケース:**
```
Given: 同一セッションで同一商品の同一ソースリンクを5分以内に2回クリックする
When: クリック計測を実行する
Then: 1回目のクリックのみが記録される
And: 2回目のクリックは重複として除外される
And: 重複クリック数が0件になる
```

### 4. 課金で機能解放

**検証項目:**
- [ ] 無料プラン制限（比較3個・お気に入り10個・アラート5個）が適用される
- [ ] 有料プラン解放（比較10個・お気に入り100個・アラート50個）が動作する
- [ ] Stripe決済による月額・年額プランが動作する
- [ ] 課金エラー時の猶予期間（7日間）と段階的制限が動作する

**テストケース:**
```
Given: 無料プランユーザーが比較商品を4個追加しようとする
When: 機能制限チェックを実行する
Then: 3個制限により追加が拒否される
And: アップグレード促進メッセージが表示される

Given: 有料プランに加入する
When: 機能制限を確認する
Then: 比較10個・お気に入り100個・アラート50個が利用可能になる
```

### 5. JSON-LD検証

**検証項目:**
- [ ] Review構造化データ（reviewBody・author・datePublished・reviewRating）が実装される
- [ ] ItemList構造化データ（商品一覧・比較結果・お気に入り一覧）が実装される
- [ ] Google Rich Results Testでの検証が通過する
- [ ] 構造化データエラー時の修正提案が出力される

**テストケース:**
```
Given: 商品詳細ページを表示する
When: JSON-LD構造化データを検証する
Then: Review・ItemList構造化データが正しく生成される
And: Google Rich Results Testが通過する
And: schema.org仕様に準拠する
```

## 横断DoD（Definition of Done）

### 収益化機能
- [ ] アフィリエイト収益・サブスクリプション収益・総収益の表示が動作
- [ ] ソース別・商品別・時間別のクリック数とコンバージョン率表示が動作
- [ ] MRR・チャーン率・収益予測の計算が正確
- [ ] CSV・JSON形式でのデータエクスポートが動作

### 信頼性機能
- [ ] 安全口コミ要約パイプライン（入力→フィルタ→要約→検証→出力）が動作
- [ ] 3ヶ月・6ヶ月・1年の期間選択による価格履歴表示が動作
- [ ] 4ソース全てのアフィリエイトリンク生成が動作
- [ ] 重複クリック防止機能が確実に動作

### 品質保証
- [ ] CI品質チェック（禁止表現0・グラフ整合性・クリック重複なし・課金機能解放）が全て通過
- [ ] A11y強化（グラフテーブル代替・キーボードナビ・料金テーブルa11y）が実装済み
- [ ] ドキュメント更新（MONETIZATION・COMPLIANCE・SEO仕様書）が完了