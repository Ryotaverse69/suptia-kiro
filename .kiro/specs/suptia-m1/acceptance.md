# Acceptance Criteria

**specVersion**: 2025-08-16

## M1: ユーザー体験拡張 - 受け入れ基準

### 1. 3ソース以上での最安値表示

**検証項目:**
- [ ] Amazon・iHerbを含む4ソースから価格情報を取得できる
- [ ] 最低3ソースの価格情報が表示される
- [ ] 3ソース未満の場合に「価格情報不足」警告が表示される
- [ ] 最安値商品に視覚的なバッジが表示される

**テストケース:**
```
Given: 商品詳細ページを表示する
When: 価格情報を取得する
Then: 楽天・Yahoo・Amazon・iHerbの4ソースから価格が取得される
And: 最低3ソースの価格が表示される
And: 最安値にバッジが表示される
```

### 2. 比較機能の並べ替え・アクセシビリティ

**検証項目:**
- [ ] 最大4商品の横並び比較が表示される
- [ ] 価格・スコア・実効コスト/日・信頼度で並べ替えできる
- [ ] ブランド・価格帯・容量・評価スコアでフィルタリングできる
- [ ] 比較結果をURLで共有できる
- [ ] 比較テーブルに適切なcaption・rowheader・columnheader属性が設定される

**テストケース:**
```
Given: 比較ビューで4商品を選択する
When: 価格順で並べ替えを実行する
Then: 商品が価格の昇順で表示される
And: テーブルに適切なARIA属性が設定される
And: キーボードナビゲーションが動作する
```

### 3. 通知の単発保証

**検証項目:**
- [ ] 同一商品・同一条件で24時間以内の重複通知が防止される
- [ ] 価格変動検知が正確に動作する
- [ ] メール通知が正しい内容で送信される
- [ ] 1日最大5通、週最大20通の制限が機能する
- [ ] ワンクリック配信停止が動作する

**テストケース:**
```
Given: 商品Aに価格アラートを設定する
When: 24時間以内に同じ条件で価格変動が2回発生する
Then: 通知は1回のみ送信される
And: 重複通知は送信されない
```

### 4. CI a11y強化

**検証項目:**
- [ ] axe-coreによる全ページ自動テストが通過する
- [ ] PriceTable・CompareViewでcaption・scope・aria-sort属性が確認される
- [ ] 全インタラクティブ要素でTab・Enter・Space・Arrow操作が確認される
- [ ] A11y違反検出時にCIが失敗し、具体的な修正提案が出力される

**テストケース:**
```
Given: CIパイプラインでA11yテストを実行する
When: アクセシビリティ違反が検出される
Then: CIが失敗する
And: 具体的な修正提案が出力される
And: 違反箇所が明確に特定される
```

## 横断DoD（Definition of Done）

### CI必須チェック
- [ ] format:check, lint, test, typecheck, build, headers, jsonld の7チェックが全て緑色
- [ ] A11yライトE2E（WarningBanner/ScoreDisplay/PriceTable）が通過
- [ ] 境界値テストで4ソース価格正規化が検証済み

### 機能統合
- [ ] Amazon・iHerbコネクタが動作（モック含む）
- [ ] GTIN/JAN優先マッチング＋信頼度スコアが実装済み
- [ ] お気に入り追加・削除・並べ替えが動作
- [ ] 価格アラート設定（目標価格・割引率・在庫復活）が動作

### ドキュメント
- [ ] README.mdにM1新機能（Compare・Favorites・Alerts）が追記済み
- [ ] docs/API.mdにAmazon・iHerb連携仕様が記載済み
- [ ] docs/A11Y.mdにテーブルa11y・キーボードナビ仕様が記載済み
- [ ] docs/NOTIFICATIONS.mdに通知キュー・メール配信仕様が記載済み