name: PR DoD Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'

jobs:
  pr-dod-validation:
    name: PR DoD Validation
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts
        working-directory: apps/web

      - name: Run DoD Check
        id: dod-check
        run: |
          cd apps/web
          if node ../../scripts/check-dod.mjs > dod-results.txt 2>&1; then
            echo "dod_passed=true" >> $GITHUB_OUTPUT
          else
            echo "dod_passed=false" >> $GITHUB_OUTPUT
          fi
          cat dod-results.txt
        continue-on-error: true

      - name: Comment PR with DoD Results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // DoDãƒã‚§ãƒƒã‚¯çµæœã‚’èª­ã¿è¾¼ã¿
            let dodResults = '';
            try {
              dodResults = fs.readFileSync('apps/web/dod-results.txt', 'utf8');
            } catch (error) {
              dodResults = 'DoDãƒã‚§ãƒƒã‚¯çµæœã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            }
            
            const dodPassed = '${{ steps.dod-check.outputs.dod_passed }}' === 'true';
            
            const comment = `## ğŸ“‹ Definition of Done (DoD) è‡ªå‹•ãƒã‚§ãƒƒã‚¯çµæœ

            ${dodPassed ? 'âœ… **ã™ã¹ã¦ã®DoDãƒã‚§ãƒƒã‚¯ãŒé€šéã—ã¾ã—ãŸï¼**' : 'âŒ **ä¸€éƒ¨ã®DoDãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¦ã„ã¾ã™**'}

            ### è©³ç´°çµæœ
            \`\`\`
            ${dodResults}
            \`\`\`

            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            ${dodPassed 
              ? '- ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒé€šéã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼ã§ãã¾ã™\n- ãƒãƒ¼ã‚¸å‰ã«æœ€çµ‚ç¢ºèªã‚’è¡Œã£ã¦ãã ã•ã„' 
              : '- å¤±æ•—ã—ãŸãƒã‚§ãƒƒã‚¯é …ç›®ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„\n- ä¿®æ­£å¾Œã€å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã¨è‡ªå‹•çš„ã«å†ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¾ã™'
            }

            ### æ‰‹å‹•ç¢ºèªãŒå¿…è¦ãªé …ç›®
            ä»¥ä¸‹ã®é …ç›®ã¯æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„ï¼š
            - [ ] ä¾¡æ ¼ãƒãƒƒãƒãƒ³ã‚°ï¼ˆ2ã‚½ãƒ¼ã‚¹/å•†å“ã€æœ€å®‰å€¤è¡¨ç¤ºï¼‰
            - [ ] å®ŸåŠ¹ã‚³ã‚¹ãƒˆ/æ—¥ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
            - [ ] è¨ºæ–­â†’å•†å“è©³ç´°ãƒ•ãƒ­ãƒ¼ã§ã®NGè¡¨ç¾ã‚¼ãƒ­
            - [ ] UIçµ±åˆï¼ˆScoreDisplay + PersonaWarnings + PriceTableï¼‰
            - [ ] ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å¯¾å¿œï¼‰

            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚æœ€æ–°ã®çµæœã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚*`;

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Definition of Done (DoD) è‡ªå‹•ãƒã‚§ãƒƒã‚¯çµæœ')
            );

            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Set PR Status
        if: steps.dod-check.outputs.dod_passed == 'false'
        run: |
          echo "::warning::ä¸€éƒ¨ã®DoDãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¦ã„ã¾ã™ã€‚è©³ç´°ã¯PRã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          exit 1