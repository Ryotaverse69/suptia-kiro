name: Comprehensive CI Pipeline

on:
  push:
    branches: [master, dev]
  pull_request:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

defaults:
  run:
    working-directory: apps/web

jobs:
  # å¿…é ˆãƒã‚§ãƒƒã‚¯: ãƒ“ãƒ«ãƒ‰
  build:
    name: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        env:
          NEXT_PUBLIC_BASE_URL: http://localhost:3000
          NEXT_PUBLIC_SANITY_PROJECT_ID: demo
          NEXT_PUBLIC_SANITY_DATASET: production
        run: pnpm run build

  # å¿…é ˆãƒã‚§ãƒƒã‚¯: ãƒ†ã‚¹ãƒˆ
  test:
    name: test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run comprehensive tests
        run: |
          echo "ğŸ§ª Running comprehensive test suite..."
          pnpm run test --run
          echo "âœ… All tests completed"

      - name: Generate test coverage report
        run: pnpm run test:coverage --run

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: apps/web/coverage/
          retention-days: 30  #
 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»: pnpm audit
  security-audit:
    name: security-audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true  # è­¦å‘Šãƒ¬ãƒ™ãƒ«
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit (è¦ä»¶8.6)
        run: |
          echo "ğŸ” Running pnpm security audit..."
          pnpm audit --audit-level moderate || echo "âš ï¸ Security vulnerabilities found (warning level)"
          echo "âœ… Security audit completed"

      - name: Generate audit report
        run: |
          pnpm audit --json > audit-report.json || true
          echo "ğŸ“Š Audit report generated"

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: apps/web/audit-report.json
          retention-days: 30

  # é™çš„è§£æ: Semgrep
  static-analysis:
    name: static-analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true  # è­¦å‘Šãƒ¬ãƒ™ãƒ«
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Semgrep (è¦ä»¶8.6)
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/javascript
            p/typescript
            p/react
            p/nextjs
            p/security-audit
          generateSarif: "1"
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-results
          path: semgrep.sarif
          retention-days: 30  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£
æŸ»: Lighthouse CI
  lighthouse-ci:
    name: lighthouse-ci
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true  # è­¦å‘Šãƒ¬ãƒ™ãƒ«
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        env:
          NEXT_PUBLIC_BASE_URL: http://localhost:3000
          NEXT_PUBLIC_SANITY_PROJECT_ID: demo
          NEXT_PUBLIC_SANITY_DATASET: production
        run: pnpm run build

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: Run Lighthouse CI (è¦ä»¶8.6)
        run: |
          echo "ğŸš€ Running Lighthouse CI..."
          lhci autorun || echo "âš ï¸ Lighthouse CI completed with warnings"
          echo "âœ… Performance audit completed"
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: 30

  # DoDåŸºæº–ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯
  dod-verification:
    name: dod-verification
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build, test, security-audit, static-analysis, lighthouse-ci]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify DoD criteria (è¦ä»¶8.6)
        run: |
          echo "ğŸ“‹ Verifying Definition of Done criteria..."
          
          # 1. ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒç·‘è‰²
          echo "âœ… Tests: ${{ needs.test.result }}"
          
          # 2. ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸ
          echo "âœ… Build: ${{ needs.build.result }}"
          
          # 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ï¼ˆè­¦å‘Šãƒ¬ãƒ™ãƒ«ï¼‰
          echo "âš ï¸ Security Audit: ${{ needs.security-audit.result }}"
          
          # 4. é™çš„è§£æï¼ˆè­¦å‘Šãƒ¬ãƒ™ãƒ«ï¼‰
          echo "âš ï¸ Static Analysis: ${{ needs.static-analysis.result }}"
          
          # 5. Lighthouse CIï¼ˆè­¦å‘Šãƒ¬ãƒ™ãƒ«ï¼‰
          echo "âš ï¸ Lighthouse CI: ${{ needs.lighthouse-ci.result }}"
          
          echo "ğŸ“Š DoD verification completed"

      - name: Run additional DoD checks
        run: |
          echo "ğŸ” Running additional DoD checks..."
          
          # lint/formatãƒã‚§ãƒƒã‚¯
          pnpm run lint || echo "âš ï¸ Lint issues found"
          pnpm run format:check || echo "âš ï¸ Format issues found"
          
          # å‹ãƒã‚§ãƒƒã‚¯
          pnpm run typecheck || echo "âš ï¸ Type errors found"
          
          echo "âœ… Additional checks completed"